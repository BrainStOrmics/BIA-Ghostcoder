# 单细胞RNA测序数据分析工作流指南

这份指南概述了一个典型的单细胞RNA测序数据分析流程，从原始数据到下游解读，旨在提供从数万到数十万细胞中提取生物学见解的步骤。许多步骤是迭代的，尤其是在探索不同分辨率下的细胞异质性时。

## 1. Raw Data Processing (原始数据处理)

### 目的 (Purpose)
将原始测序机输出（通常为 FASTQ 文件）转换为每个细胞中每个基因的分子计数矩阵。

### 描述 (Description)
这是分析的起点。该步骤涉及将测序读段比对/映射到参考基因组或转录组，识别和校正细胞条形码 (CB)，以及通过唯一分子标识符 (UMI) 解析来估计分子计数。这些步骤处理了测序过程中可能出现的错误和偏差，例如索引跳跃 (index hopping) 和测序错误。常见的工具包括 Cell Ranger (商业软件)、zUMIs、alevin、kallisto|bustools、STARsolo 和 alevin-fry。有些工具会生成传统的比对文件（如 BAM），而另一些则在内存中操作或使用更紧凑的表示形式。细胞条形码校正通常依据已知白名单或基于频率分布的“膝部”/“肘部”识别。UMI 解析旨在区分 PCR 重复和原始 mRNA 分子，处理测序错误和多映射读段。

### 可以个性化的部分 (Personalizable Parts)
- 选择具体的处理工具（例如，alevin-fry 被认为是快速、准确且内存节省的工具）。
- 选择参考基因组/转录组及其版本（推荐使用 splici 参考，它包含剪接和未剪接序列）。
- 条形码校正策略的选择（基于已知列表、膝部/肘部方法、预期细胞数或强制细胞数）。
- 是否量化未剪接 (unspliced) 和模糊 (ambiguous) 读段信息（如 alevin-fry 的 USA 模式），这对于 RNA velocity 等下游分析很重要。
- 处理双重测序 (doublet) 或空液滴 (empty droplet) 的策略。

### 输入数据 (Input)
- 原始测序 FASTQ 文件（通常是 lane-demultiplexed 的）。
- 参考基因组 FASTA 文件和基因注释 GTF 文件。

### 输出数据 (Output)
- 细胞-基因计数矩阵（或读段矩阵，如果未使用 UMI）。
- 可能包含剪接和未剪接的计数矩阵。
- 原始数据处理阶段的质量控制指标报告（例如，映射率、UMI 重复率、检测到的基因分布）。

## 2. Quality Control (Count Matrix) (计数矩阵质量控制)

### 目的 (Purpose)
识别并移除低质量细胞、环境 RNA 污染以及双重测序细胞，以获得一个高质量数据集，其中每个观察代表一个完整的单细胞。

### 描述 (Description)
在获得计数矩阵后，需要对其进行质量控制。这包括评估细胞的测序深度（总计数）、检测到的基因数量和线粒体基因计数百分比等指标。低质量细胞（可能因为膜破裂或濒死）通常表现为低总计数、低基因数量和高线粒体计数百分比。此外，需要校正液滴测序协议中的环境 RNA 污染（细胞外 mRNA 被错误地包含在液滴中），使用 SoupX 或 DecontX。还必须检测并处理双重测序细胞（一个液滴中包含多个细胞），它们可能扭曲下游分析。常用的双重测序检测工具包括 Scrublet、scDblFinder、DoubletDetection 和 SOLO。

### 可以个性化的部分 (Personalizable Parts)
- 过滤低质量细胞的阈值选择：可以手动基于 QC 指标分布确定，或使用自动方法如基于中位数绝对偏差 (MAD) 的过滤。应倾向于更宽松的阈值以避免丢失稀有细胞群。
- 环境 RNA 校正工具的选择。
- 双重测序检测工具的选择，以及是移除双重测序细胞还是仅标记它们。
- 对于多批次数据集，建议对每个批次单独执行 QC，因为质量指标阈值可能不同。
- QC 策略可以在后续聚类或注释后重新评估。

### 输入数据 (Input)
- 来自原始数据处理的细胞-基因计数矩阵。

### 输出数据 (Output)
- 过滤后的细胞-基因计数矩阵（仅包含高质量细胞）。
- 更新的细胞元数据，包含 QC 指标、环境 RNA 校正信息和双重测序分数/分类。

## 3. Normalization (标准化)

### 目的 (Purpose)
调整原始计数，纠正技术变异（如文库大小、细胞大小），稳定方差，使细胞间的基因表达量具有可比性。

### 描述 (Description)
单细胞数据中的计数差异可能仅仅是由于采样效应造成的。标准化旨在移除这种技术噪声，同时保留生物学异质性。不同的标准化技术有不同的设计目标和下游适用性。常见方法包括：
- Shifted logarithm (对数加一转换)：通过文库大小缩放（例如，总计数或中位数计数缩放）加上一个伪计数（通常是 1）后进行对数转换。这是许多工作流中的标准步骤。
- scran normalization：基于细胞聚类计算大小因子，然后进行缩放。在 Bioconductor 生态系统中常用。
- Analytic Pearson residuals：使用正则化负二项模型拟合计数深度与方差的关系，然后计算 Pearson 残差。旨在更好地移除技术效应同时保留生物学信号。
- SCTransform：Seurat 生态系统中的一种替代方法，直接对原始 UMI 计数进行建模和方差稳定化，取代了传统的标准化、缩放和可变特征选择步骤。

### 可以个性化的部分 (Personalizable Parts)
- 选择具体的标准化方法。不同的方法适用于不同的下游任务，例如 Pearson residuals 适用于特征选择。
- 对于基于缩放的方法，选择大小因子的计算方式（例如，总计数、中位数计数、CP10k、CPM）。
- 对于 SCTransform 等方法，可以选择回归掉协变量（如线粒体计数百分比）。
- 可以尝试多种方法并将结果存储为 AnnData 对象的不同层 (layer) 或 Seurat 对象的不同 Assay/Layer 进行比较。

### 输入数据 (Input)
- 来自质量控制的过滤后的细胞-基因计数矩阵。

### 输出数据 (Output)
- 标准化的基因表达矩阵。
- 原始计数通常保留在一个单独的层中。

## 4. Feature Selection (特征选择)

### 目的 (Purpose)
从标准化后的数据中选择信息量最大或变异最大的基因子集，减少数据维度和噪声，聚焦下游分析。

### 描述 (Description)
大多数单细胞数据集中包含大量表达水平低或在细胞间变化不大的基因，它们对区分细胞类型或状态作用不大，反而可能引入噪声。特征选择步骤识别在不同细胞中表现出显著变异的基因，通常称为高变异基因 (Highly Variable Genes, HVG)。不同的算法（如 Seurat、Cell Ranger、Seurat v3 中的实现）计算基因的平均表达和变异，以确定 HVG。

### 可以个性化的部分 (Personalizable Parts)
- 选择 HVG 选择的算法或“flavor”。
- 选择要保留的基因数量（通常根据数据集大小和复杂性选择几百到几千个基因，例如 500-2000）。
- 注意标准化方法对 HVG 选择结果的影响。
- SCTransform 等方法将标准化和 HVG 选择整合在一起。

### 输入数据 (Input)
- 来自标准化的基因表达矩阵。

### 输出数据 (Output)
- 标记出哪些基因被选为特征的基因列表或 AnnData 对象变量 (var) 中的标记。
- 后续分析通常在仅包含这些选定特征的矩阵上进行。

## 5. Dimensionality Reduction & Graph Construction (降维与图构建)

### 目的 (Purpose)
将高维基因表达数据投影到较低维度的空间中，以便可视化细胞间的关系、去噪，并作为后续聚类等任务的输入。同时构建细胞邻域图。

### 描述 (Description)
单细胞数据存在“维度诅咒”问题，高维度中噪声和冗余可能掩盖真实信号。降维方法创建一组新的、信息更集中的变量。
- PCA (Principal Component Analysis)：一种线性降维方法，找到解释数据最大方差的几个主成分。常用于去噪和获得初始低维表示。
- t-SNE (t-Distributed Stochastic Neighbor Embedding) / UMAP (Uniform Manifold Approximation and Projection)：非线性降维方法，旨在保留高维空间中的细胞间相似性（局部和/或全局拓扑结构），并将其可视化在二维或三维空间中。
- Nearest Neighbor Graph (KNN Graph)：在降维后的空间中计算细胞之间的距离，构建一个图，其中相似的细胞由边连接。这个图是许多后续分析（如聚类、轨迹推断）的基础。

### 可以个性化的部分 (Personalizable Parts)
- 选择降维方法（PCA 是常见的第一步，然后是 UMAP 或 t-SNE 用于可视化）。对于 ATAC 数据，LSI (Latent Semantic Indexing) 也是一种选择。
- 选择保留的主成分数量（例如，通过绘制肘部图 (elbow plot) 或根据解释的方差比例确定，或者基于生物学信号评估）。
- UMAP/t-SNE 的参数设置（例如，perplexity, spread）。
- KNN 图的邻居数量 (k)，这会影响图的局部结构。
- 可视化可以帮助评估之前的 QC 结果（例如，在 UMAP 图上查看 QC 指标）。

### 输入数据 (Input)
- 来自特征选择的基因表达矩阵（或标准化后的矩阵，如果跳过特征选择）。

### 输出数据 (Output)
- 低维嵌入坐标（例如，AnnData 对象的 obsm 中的 X_pca, X_umap）。
- 最近邻图（例如，AnnData 对象的 obsp 中的 distances, connectivities）。

## 6. Data Integration (Optional) (数据整合)

### 目的 (Purpose)
当分析来自不同批次、捐献者、实验条件或技术的多个数据集时，移除技术差异（批次效应），从而可以比较和整合生物学信号。

### 描述 (Description)
批次效应是 scRNA-seq 数据分析中的一个主要挑战。整合方法旨在将来自不同批次的、处于相似生物学状态的细胞对齐。整合可以在工作流的不同阶段进行，例如在标准化后、降维后或作为降维和聚类过程的一部分。方法包括：
- 线性嵌入方法：例如 Mutual Nearest Neighbors (MNN)、Seurat 的 CCA 整合、Harmony。它们通常在低维空间中寻找跨批次的相似细胞。
- 基于图的方法：例如 BBKNN (Batch Balanced KNN)，它修改了 KNN 图的构建方式以强制连接跨批次的细胞。
- 深度学习方法：例如 scVI、scANVI、scGen，它们使用变分自编码器 (VAE) 等模型学习批次校正后的低维表示。scANVI 可以利用细胞标签信息来更好地保留生物学差异。
- 参考映射方法：例如 ingest、scArches、Symphony、Seurat 的 reference mapping。这些方法在一个已注释的参考数据集上训练模型，然后将新的（查询）数据映射到参考空间中，而不是对称地整合所有数据集。
- 评估整合质量：scIB 等工具箱提供了量化整合性能的指标，衡量批次效应移除程度和生物学变异保留程度。

### 可以个性化的部分 (Personalizable Parts)
- 选择整合方法：取决于批次效应的复杂性（简单 vs 复杂），是否有细胞标签可用，所需的输出格式（校正后的嵌入还是校正后的表达矩阵），以及计算资源。Benchmarks 可以提供指导（例如，Harmony 和 Seurat 适用于简单任务，深度学习和 Scanorama 适用于复杂任务）。
- 选择批次协变量（例如，样本、捐献者、数据集）：取决于分析目标，精细的批次分辨率移除的效应更多，但也可能与生物学信号混淆。
- 方法特定的参数调整。
- 对于有标签的数据，可能需要先进行标签协调 (label harmonization)。

### 输入数据 (Input)
- 标准化或特征选择后的基因表达数据。
- 可能包含初步降维和图构建的结果。
- 细胞元数据中指示批次信息的列。
- 如果使用标签感知方法或参考映射，需要细胞标签信息。

### 输出数据 (Output)
- 整合后的数据表示（例如，批次校正后的低维嵌入或校正后的表达矩阵）。
- 整合后的最近邻图。

## 7. Clustering (聚类)

### 目的 (Purpose)
将具有相似基因表达模式的细胞分组，形成细胞簇，这些细胞簇代表潜在的细胞类型或细胞状态。

### 描述 (Description)
聚类是一种常见的无监督机器学习问题。在单细胞分析中，通常在降维后的空间中构建最近邻图，然后在图上应用基于图的聚类算法来识别社区。常用的算法包括 Leiden 和 Louvain。这些算法通过优化模块度来将图划分为高度连接的社区。聚类是后续细胞类型注释的基础。

### 可以个性化的部分 (Personalizable Parts)
- 选择聚类算法（Leiden 通常被推荐，因为它能保证良好连接的社区）。
- 分辨率 (resolution) 参数的设置：控制聚类结果的粒度，值越大通常得到越多越小的簇。最优分辨率取决于数据集大小。
- 聚类基于的输入：是使用未经整合的降维嵌入和图，还是使用数据整合后的嵌入和图。
- 可以进行亚聚类 (sub-clustering) 来进一步细分感兴趣的细胞群。

### 输入数据 (Input)
- 来自降维与图构建 或 数据整合 的最近邻图。
- 相应的低维嵌入（用于可视化聚类结果）。

### 输出数据 (Output)
- 每个细胞所属的聚类标签（通常存储在 AnnData 对象的 obs 中）。

## 8. Annotation (注释)

### 目的 (Purpose)
为已识别的细胞簇赋予生物学意义，将其标记为特定的细胞类型或状态。对于癌症样本中恶性细胞的识别，可以利用拷贝数变异 (Copy Number Variation, CNV) 的特征。

### 描述 (Description)
细胞类型定义是一个基于特定标志基因的细胞表型，在数据集之间通常是稳健的。注释过程可以是：
- Manual annotation (手动注释)：基于已知的标志基因。通过可视化标志基因在不同簇中的表达来识别细胞类型。这种方法直观透明，但在没有独特标志基因或处理复杂数据时可能具有主观性。
- Automated annotation (自动注释)：使用预训练的分类器根据细胞的基因表达模式直接预测细胞类型。这些分类器通常基于机器学习方法。这种方法快速、易于使用，并可利用现有高质量注释。
- Reference mapping (参考映射)：将待注释的数据集映射到已详细注释的参考图谱上，并将其标签转移到查询细胞。这种方法依赖于高质量的参考数据集，并且性能受数据集相似度影响。细胞类型还可以进一步细分为亚型或细胞状态。一些研究者使用“细胞身份 (cell identity)”一词来避免这种区分。
- Inference of Copy Number Variation (CNV) (拷贝数变异推断)：对于肿瘤样本，恶性细胞通常具有显著的 CNV。工具如 infercnv 和 copycat 可以从单细胞 RNA 测序数据中推断 CNV，从而辅助识别恶性细胞群体。这些工具通过分析染色体上基因的平均表达水平，与正常细胞进行比较，识别拷贝数增加或减少的区域。

### 可以个性化的部分 (Personalizable Parts)
- 选择注释策略：手动、自动分类器或参考映射。
- 手动注释时，选择使用的标志基因集合，并结合生物学专业知识。标志基因需要根据具体组织和实验数据进行验证。
- 自动注释或参考映射时，选择合适的预训练模型或参考图谱，确保其与查询数据具有相似的技术和生物学特征。
- 使用 infercnv 或 copycat 进行 CNV 推断时，需要提供一组已知的正常细胞作为参考。参考细胞的选择至关重要，可以基于已注释的非恶性细胞类型或来自健康个体的单细胞数据。
- 注释的粒度（例如，注释到大类细胞类型还是更精细的亚型/状态）。

### 输入数据 (Input)
- 来自聚类的细胞簇标签。
- 标准化的基因表达矩阵。
- 来自降维与图构建 或 数据整合 的低维嵌入（用于可视化标志基因表达）。
- 如果使用自动或参考映射方法，需要预训练的分类器模型或已注释的参考数据集。
- 对于 infercnv/copycat：需要指定正常细胞群体（基于初步注释或其他先验知识）。

### 输出数据 (Output)
- 每个细胞或细胞簇的生物学标签（例如，存储在 AnnData 对象的 obs 中）。

## 9. Iterative Subpopulation Definition and Analysis Loop (迭代亚群定义和分析循环)

### 目的 (Purpose)
在更精细的分辨率下识别和分析更细微的亚群或细胞状态。

### 描述 (Description)
在初步聚类和注释（步骤 8）识别出大的细胞类型后，通常需要对某些细胞群进行更深入的分析，以揭示其内部更精细的亚群结构或细胞状态。这是一个迭代的过程，可以重复进行多次。

#### 过程 (Process)
- **(新增) 选择要深入分析的亚群 (Select Subpopulation for In-depth Analysis)**：基于初步注释（步骤 8）和您的生物学研究问题，选择您最感兴趣的特定细胞类型或细胞簇进行进一步的详细分析。至关重要的是，亚群的选择应与您希望在研究中探索或验证的生物学故事保持一致，确保分析的方向具有生物学意义。在计划这一步时，请同时考虑哪些下游分析（例如，轨迹推断是否适用于细胞状态的变化，细胞间通讯是否在这些亚群之间有意义，特定条件下的差异表达是否是关注点）对于这些选定的亚群和您的生物学问题是相关的且有价值的。这将在很大程度上决定后续需要重复的步骤和分析方向。
- **重复特征选择 (Subset-specific Feature Selection)**：在选定的细胞子集上，重新识别高变基因或信息量大的特征。这是因为在整个数据集中高变的基因可能与在特定细胞群子集中高变的基因不同，针对子集进行特征选择能更好地捕获该亚群特有的变异信息。
- **重复降维与图构建 (Subset-specific Dimensionality Reduction & Graph Construction)**：使用亚群子集数据（基于重新选择的特征），重新计算降维嵌入（如 PCA、UMAP/t-SNE）并构建新的近邻图。这些步骤有助于更好地可视化和分析亚群内部的结构。
- **重复聚类 (Subset-specific Clustering)**：在为子集构建的新近邻图上，重新应用聚类算法（如 Leiden），以识别亚群内部的更精细分组。
- **重复注释 (Subset-specific Annotation)**：为新识别的亚群（子聚类）分配生物学标签。这通常通过识别亚群特异性标记基因来完成，可能需要进行差分基因表达分析来找出在不同亚群之间有显著表达差异的基因。
- **[执行亚群特异性下游分析] ([Perform Subpopulation-specific Downstream Analysis])**：一旦亚群被定义到所需的分辨率，就可以执行针对这些亚群的分析，例如：在不同亚群之间或在特定亚群的不同条件之间进行差分基因表达分析；如果亚群代表连续过程，进行细胞轨迹推断（伪时间、RNA 速度）；分析亚群之间的细胞间通讯；对亚群特异性基因或差异表达基因进行基因集富集和通路分析；推断亚群特定的基因调控网络；分析亚群对扰动（如果适用）的反应；或分析亚群在不同条件下的相对丰度变化。

#### 可选：重新评估 QC ([Optional: Re-assess QC])
基于聚类或注释结果（无论是整体还是亚群），如有必要，重新审视初始 QC 过滤参数（例如，如果在某些簇中观察到明显的双细胞或低质量细胞迹象）。这可能需要从步骤 2 开始重新运行流程。

## 10. Further Downstream Analysis (Advanced) (下游分析)

### 目的 (Purpose)
在预处理和核心分析完成后，使用处理和注释好的单细胞数据，针对特定的生物学问题进行更深入的探索和分析。

### 描述 (Description)
核心分析流程提供了一个基础数据集，在此基础上可以进行各种高级分析。这些分析的类型取决于实验设计和研究者希望回答的生物学问题。以下是涵盖的多种下游分析任务：
- **Differential Gene Expression (DGE) Analysis (差异基因表达分析)**：比较不同细胞群（例如，不同细胞类型、不同条件下的同一细胞类型）之间的基因表达差异。方法包括基于伪批量 (pseudobulk) 的方法 (edgeR, DESeq2) 和单细胞特异性方法 (MAST, glmmTMB)。
- **Compositional Analysis (组分分析)**：分析不同条件下细胞类型比例的变化。方法包括 scCODA、tascCODA 和基于 KNN 的方法 (DA-seq, Milo, MELD)。
- **Gene Set Enrichment and Pathway Analysis (基因集富集和通路分析)**：识别在特定细胞群或条件下富集的基因集（如生物过程、信号通路）。方法包括基因集检验 (GSEA, fry, camera) 和通路活性推断 (AUCell, Pagoda2, PROGENy, DoRothEA)。
- **Pseudotemporal Ordering / Trajectory Inference (伪时间排序 / 轨迹推断)**：基于细胞的基因表达相似性，重建细胞在发育或分化过程中的动态轨迹。方法包括 DPT、Palantir、Slingshot 和 PAGA。
- **RNA Velocity (RNA 速度)**：利用已剪接和未剪接 mRNA 的相对丰度，推断细胞基因表达变化的瞬时速率和方向，预测细胞的短期未来状态。使用 scVelo 等工具进行分析。
- **Cell-cell Communication (CCC) (细胞间通讯)**：根据细胞类型的基因表达推断它们之间的相互作用，通常基于配体-受体相互作用。方法包括 CellPhoneDB、LIANA 和 NicheNet，其中 NicheNet 还考虑下游信号传导效应。
- **Gene Regulatory Networks (GRN) Inference (基因调控网络推断)**：建模转录因子 (TF) 如何调控靶基因的表达。SCENIC 是一个常用的工具，通过分析 TF 及其靶基因的共表达来推断调控子 (regulon)。
- **Perturbation Modeling (扰动建模)**：分析或预测细胞对实验扰动（如基因敲除、药物处理）的反应。方法包括 Augur（识别最受影响的细胞类型）和 scGen（预测扰动反应）。
- **Lineage Tracing (谱系追踪)**：利用细胞基因组中积累的分子标记（如 CRISPR/Cas9 产生的基因组编辑），重建细胞的祖先-后代关系和增殖历史。工具如 Cassiopeia 和 CoSpar。注意：这类分析通常需要专门的实验设计和原始数据处理，可能与标准 scRNA-seq 流程在早期阶段有所不同。

### 可以个性化的部分 (Personalizable Parts)
- 选择进行哪些下游分析取决于具体的生物学问题和实验设计。
- 每个下游分析领域都有多种方法可供选择，需要根据数据类型、问题性质、可用工具的特点（如速度、准确性、是否需要先验知识、是否考虑多模态数据等）进行选择。
- 许多下游分析方法有特定的输入要求（例如，DGE 需要标准化计数和条件标签，RNA Velocity 需要未剪接计数，NicheNet 需要感兴趣的基因集）。
- 分析结果的解释需要结合生物学背景知识。

### 输入数据 (Input)
- 来自 Annotation 的处理、整合（如果需要）、聚类和注释后的单细胞数据。
- 根据具体分析需求，可能需要原始计数、标准化计数、低维嵌入、图结构、细胞标签、标志基因、实验条件、时间点、扰动信息等。
- 某些分析（如谱系追踪）需要专门处理的原始数据。
- 外部数据库或知识库（如通路数据库、配体-受体数据库、TF-靶基因数据库）。

### 输出数据 (Output)
- 特定分析的结果（例如，差异表达基因列表、通路富集分数、细胞类型比例变化、伪时间值、速度向量、预测的细胞间相互作用、推断的调控网络）。